name: ðŸš€ Auto Deploy to EC2 (Docker)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”‘ Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_KEY }}

      - name: ðŸ§± Build Docker image
        run: docker build -t mcp-auth-backend .

      - name: ðŸ“¦ Save Docker image as tar
        run: |
          sudo chmod -R 777 .
          docker save mcp-auth-backend -o mcp-auth-backend.tar

      - name: ðŸš€ Copy Docker image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          source: "mcp-auth-backend.tar"
          target: "~/"

      - name: ðŸ§© Deploy on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          script: |
            sudo docker rm -f mcp-auth || true
            sudo docker load -i ~/mcp-auth-backend.tar
            sudo docker run -d -p 8080:8080 --name mcp-auth -v /home/ubuntu/mcp-auth-backend-go/.env:/app/.env mcp-auth-backend